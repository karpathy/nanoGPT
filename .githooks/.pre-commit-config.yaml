repos:
- repo: https://github.com/astral-sh/ruff-pre-commit
  rev: v0.9.6
  hooks:
  - id: ruff
    args: [--fix]
  - id: ruff-format
- repo: https://github.com/DavidAnson/markdownlint-cli2
  rev: v0.15.0
  hooks:
  - id: markdownlint-cli2
    args: ["--config", ".markdownlint-cli2.jsonc"]
    files: '(README|CONTRIBUTING|LICENSE|CHANGELOG)\.md$|^(docs|tests|\.dev-guidelines)/.*\.md$'
- repo: https://github.com/checkmake/checkmake.git
  # Or another commit hash or version
  rev: 0.2.2
  hooks:
  # Use this hook to let pre-commit build checkmake in its sandbox
  - id: checkmake
- repo: local
  hooks:
  # TODO(mock-free-refactor): re-enable coverage badge hook after coverage branch lands
  # - id: coverage-badge
  #   name: coverage badge
  #   entry: bash
  #   args:
  #     - -c
  #     - |
  #       set -e
  #       if ! compgen -G ".cache/coverage/coverage.sqlite*" > /dev/null; then
  #         COVERAGE_FILE=.cache/coverage/coverage.sqlite make coverage-test
  #       fi
  #       make coverage-badge SKIP_COVERAGE_TESTS=1
  #       git add docs/assets/coverage.svg docs/assets/coverage-lines.svg docs/assets/coverage-branches.svg
  #   language: system
  #   pass_filenames: false
  #   stages: [pre-commit]
  - id: coverage-threshold
    name: coverage threshold (>=79.00%)
    entry: bash
    args:
      - -c
      - |
        set -euo pipefail
        COVERAGE_DIR=".cache/coverage"
        if [ "${SKIP_COVERAGE_TESTS:-0}" != "1" ]; then
          rm -f "${COVERAGE_DIR}"/coverage.sqlite*
          make coverage-test
        else
          echo "[info] SKIP_COVERAGE_TESTS=1 -> reusing existing coverage data"
        fi
        if ! compgen -G "${COVERAGE_DIR}/coverage.sqlite"* > /dev/null; then
          echo "[error] No coverage data found. Run 'make coverage-test' first." >&2
          exit 2
        fi
        if compgen -G "${COVERAGE_DIR}/coverage.sqlite."* > /dev/null; then
          COVERAGE_FILE="${COVERAGE_DIR}/coverage.sqlite" uv run coverage combine
        fi
        COVERAGE_FILE="${COVERAGE_DIR}/coverage.sqlite" uv run coverage report -m --fail-under=79.00
    language: system
    pass_filenames: false
  - id: pyright
    name: pyright
    entry: uv run pyright ml_playground
    language: system
    pass_filenames: false
  - id: mypy
    name: mypy
    entry: uv run mypy --incremental ml_playground
    language: system
    pass_filenames: false
  - id: vulture
    name: vulture
    entry: uv run vulture ml_playground --min-confidence 90
    language: system
    pass_filenames: false

