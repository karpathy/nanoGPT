[build-system]
requires = ["hatchling>=1.27.0"]
build-backend = "hatchling.build"

[project]
name = "ml-playground"
version = "0.0.0"
description = "A minimal GPT training repo (uv-integrated)"
readme = "README.md"
authors = [
    { name = "Andrej Karpathy" },
]
license = { file = "LICENSE" }
requires-python = ">=3.13"
dependencies = [
    "numpy>=2.3.2",
    "requests>=2.32.5",
    "tiktoken>=0.11.0",
    "tqdm>=4.67.1",
    "datasets>=4.0.0",
    "transformers==4.56.0",
    "peft>=0.17.1",
    "beautifulsoup4>=4.13.5",
    "torch>=2.8.0",
    "pip >= 25.2",
    "tensorboard>=2.20.0",
    "torch-tb-profiler>=0.4.3",
    "pydantic>=2.11.7",
    "notebook>=7.4.5",
    "typer==0.17.3",
    "sentencepiece>=0.2.1",
    "pandas-stubs==2.3.2.250827",
    "toml>=0.10.2",
    "hatchling>=1.27.0",
]

[project.optional-dependencies]

# Optional extra: LIT integration (install only when needed)
# Note: lit-nlp currently pulls transitive deps (e.g., llvmlite via umap-learn) that
# are not compatible with Python 3.13. The extra is therefore disabled on 3.13+
# to allow `uv sync --extra lit` to succeed without attempting incompatible installs.
lit = [
    #"lit-nlp>=1.3.1; # python_version < '3.13'",
]


[tool.uv]
package = true
# Lockfile will be auto-generated by `uv lock` or `uv sync`

#[tool.uvx.scripts]
# Removed in favor of Make targets. Use the Makefile for scripts and quality gates.

[tool.uv.sources]
# allow system-specific torch wheels to be resolved from PyPI

[tool.hatch.build.targets.wheel]
packages = ["ml_playground"]


[dependency-groups]
# Mandatory dev tooling available in the project venv
# Sync with: uv sync --group dev (do NOT use --all-groups unless you intend to install optional extras)
dev = [
    "pytest>=8.4.1",
    "pytest-xdist>=3.8.0",
    "pytest-bdd>=8.1.0",
    "pytest-cov>=6.2.1",
    "pytest-mock>=3.14.1",
    "coverage[toml]>=7.10.6",
    "ruff>=0.12.11",
    "mypy>=1.17.1",
    "pyright>=1.1.405",
    "types-requests>=2.32.4.20250809",
    "vulture>=2.11.0",
    "cosmic-ray>=8.3.0",
    "hypothesis>=6.0.0",
    "tomli-w>=1.0.0",
    "pre-commit>=4.3.0",
]



[tool.ruff]
respect-gitignore = true
extend-exclude = [
    ".idea",
    ".vscode",
    "out",
    "**/out/**",
    "data",
    "datasets",
    "**/datasets/**",
    "checkpoints",
    "**/checkpoints/**",
    "*.pt",
    "runs",
    "**/runs/**",
    "wandb",
    "**/wandb/**",
    "lightning_logs",
    "**/lightning_logs/**",
    "artifacts",
    "**/artifacts/**",
    "mlruns",
    "**/mlruns/**",
    ".cache",
    "**/.cache/**",
    ".hf_cache",
    "**/.hf_cache/**",
    ".venv",
    "env",
    ".pytest_cache",
    ".mypy_cache",
    ".ruff_cache",
    ".git",
    "htmlcov",
]

[tool.mypy]
# When invoked without explicit targets, analyze only the project code.
files = ["ml_playground"]
# Also exclude common ignored/artifact directories if mypy is invoked without args.
# Additionally exclude analysis (LIT integration) to avoid pulling heavy third-party types
# that slow down type checking and are not part of core runtime.
exclude = '(^|.*/)(out/|data/|datasets/|checkpoints/|runs/|wandb/|lightning_logs/|artifacts/|mlruns/|htmlcov/|ml_playground/experiments/|ml_playground/analysis/|\\.idea/|\\.vscode/|\\.venv/|env/|\\.pytest_cache/|\\.mypy_cache/|\\.ruff_cache/|\\.hf_cache/|\\.cache/|\\.git/)'

# Speed up type checking by not following imports into third-party libraries
follow_imports = "skip"
# Avoid spending time resolving missing type stubs for external deps (torch, transformers, etc.)
ignore_missing_imports = true


[tool.pytest.ini_options]
# Updated pytest settings for ml_playground
addopts = "-W error --strict-markers --strict-config -v"
testpaths = [
    "tests",
]
norecursedirs = [
    ".git",
    ".hypothesis",
    ".idea",
    ".vscode",
    ".venv",
    "env",
    "out",
    "data",
    "datasets",
    "checkpoints",
    "runs",
    "wandb",
    "lightning_logs",
    "artifacts",
    "mlruns",
    ".hf_cache",
    ".cache",
    "htmlcov",
    ".pytest_cache",
    ".mypy_cache",
    ".ruff_cache",
]
markers = [
    "slow: marks tests as slow (deselected by default)",
    "integration: marks tests as integration tests",
    "perf: marks tests as performance tests (deselected by default)",
    "acceptance: marks tests as acceptance (deselect with '-m \"not acceptance\"')",
    "e2e: marks tests as end-to-end tests",
]
# BDD configuration for pytest-bdd
bdd_features_base_dir = "tests/acceptance/features/"

[tool.coverage.run]
source = ["ml_playground"]
branch = true
parallel = true
omit = [
    "tests/*",
    "*/conftest.py",
    "**/datasets/*",
    "**/checkpoints/*",
    "**/runs/*",
    "**/wandb/*",
    "**/lightning_logs/*",
    "**/artifacts/*",
    "**/mlruns/*",
    "**/.hf_cache/*",
    "**/.cache/*",
    # Temporarily exclude analysis (LIT integration) due to dependency issues
    "ml_playground/analysis/*",
]

[tool.coverage.report]
# ULTRA-STRICT: 100% coverage required, no exceptions
exclude_lines = [
    # Only allow exclusion for truly impossible-to-test code
    "if 0:",
    "if __name__ == .__main__.:",
]
show_missing = true
omit = [
    # Temporarily exclude analysis (LIT integration) due to dependency issues
    "ml_playground/analysis/*",
]
skip_covered = false
# STRICT REQUIREMENT: 100% coverage, no compromises
fail_under = 100
precision = 2

[tool.coverage.html]
directory = "htmlcov"

[cosmic-ray]
module-path = "ml_playground/config.py"
timeout = 3.0
excluded-modules = [
  "ml_playground/tokenizer_protocol.py",
  "ml_playground/lr_scheduler.py",
]
test-command = "pytest -q -n auto tests/unit/ml_playground/test_config.py"
no-copy-source-files = false

[cosmic-ray.distributor]
name = "local"
