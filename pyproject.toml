[build-system]
requires = ["hatchling>=1.27.0"]
build-backend = "hatchling.build"

[project]
name = "ml-playground"
version = "0.1.0"
description = "A minimal GPT training repo (uv-integrated)"
readme = "README.md"
authors = [
    { name = "Andrej Karpathy" },
]
license = { file = "LICENSE" }
requires-python = ">=3.13,<3.14"
dependencies = [
    "numpy>=2.3.2",
    "requests>=2.32.5",
    "tiktoken>=0.11.0",
    "tqdm>=4.67.1",
    "datasets>=4.0.0",
    "beautifulsoup4>=4.13.5",
    "pydantic>=2.11.7",
    "notebook>=7.4.5",
    "typer==0.17.3",
    "sentencepiece>=0.2.1",
    "pandas-stubs==2.3.2.250827",
    "toml>=0.10.2",
    "hatchling>=1.27.0",
    "pip >= 25.2",
]

[project.scripts]
env-tasks = "tools.env_tasks:main"
test-tasks = "tools.test_tasks:main"
ci-tasks = "tools.ci_tasks:main"
lint-tasks = "tools.lint_tasks:main"
lit-tasks = "tools.lit_tasks:main"
ml-playground = "ml_playground.cli:main"

[project.optional-dependencies]

# Optional extra: LIT integration (install only when needed)
# Note: lit-nlp currently pulls transitive deps (e.g., llvmlite via umap-learn) that
# are not compatible with Python 3.13. The extra is therefore disabled on 3.13+
# to allow `uv sync --extra lit` to succeed without attempting incompatible installs.
lit = [
    #"lit-nlp>=1.3.1; # python_version < '3.13'",
]


[tool.uv]
package = true
# Lockfile will be auto-generated by `uv lock` or `uv sync`

[tool.uv.sources]
# allow system-specific torch wheels to be resolved from PyPI

[tool.uvx.scripts]
env-tasks = "python tools/env_tasks.py"
test-tasks = "python tools/test_tasks.py"
ci-tasks = "python tools/ci_tasks.py"
lint-tasks = "python tools/lint_tasks.py"
lit-tasks = "python tools/lit_tasks.py"


[tool.hatch.build.targets.wheel]
packages = ["src/ml_playground"]
include = [
    "src/ml_playground",
    "src/ml_playground/**",
]

[tool.hatch.build.targets.wheel.force-include]
"tools" = "tools"

[tool.hatch.build.targets.sdist]
include = [
    "pyproject.toml",
    "src/ml_playground",
    "src/ml_playground/**",
    "tools",
    "tools/**",
]


[dependency-groups]
# Mandatory dev tooling available in the project venv
# Sync with: uv sync --group dev (do NOT use --all-groups unless you intend to install optional extras)
ml = [
    "torch==2.8.0; platform_system == 'Linux' and platform_machine == 'x86_64'",
    "torch==2.8.0; platform_system == 'Darwin' and platform_machine == 'arm64'",
    "torch==2.8.0; platform_system == 'Linux' and platform_machine != 'x86_64'",
    "torch==2.8.0; platform_system == 'Darwin' and platform_machine == 'x86_64'",
    "torch==2.8.0; platform_system == 'Windows'",
    "transformers==4.56.0",
    "peft>=0.17.1",
    "tensorboard>=2.20.0",
    "torch-tb-profiler>=0.4.3",
]
dev = [
    "pytest>=8.4.1",
    "pytest-xdist>=3.8.0",
    "pytest-bdd>=8.1.0",
    "pytest-cov>=6.2.1",
    "pytest-mock>=3.14.1",
    "coverage[toml]>=7.10.6",
    "ruff>=0.12.11",
    "mypy>=1.17.1",
    "pyright>=1.1.405",
    "types-requests>=2.32.4.20250809",
    "vulture>=2.11.0",
    "cosmic-ray>=8.3.0",
    "hypothesis>=6.0.0",
    "tomli-w>=1.0.0",
    "pre-commit>=4.3.0",
    "coverage-badge>=1.1.0",
    "mdformat>=0.7.17",
    "mdformat-gfm>=0.3.5",
    "mdformat-frontmatter>=0.4.1",
]



[tool.mdformat]
wrap = 120
number = false



[tool.ruff]
respect-gitignore = true
extend-exclude = [
    ".idea",
    ".vscode",
    "out",
    "**/out/**",
    "data",
    "datasets",
    "**/datasets/**",
    "checkpoints",
    "**/checkpoints/**",
    "*.pt",
    "runs",
    "**/runs/**",
    "wandb",
    "**/wandb/**",
    "lightning_logs",
    "**/lightning_logs/**",
    "artifacts",
    "**/artifacts/**",
    "mlruns",
    "**/mlruns/**",
    ".cache",
    "**/.cache/**",
    ".venv",
    "env",
    ".git",
    "htmlcov",
]
cache-dir = ".cache/ruff"

[tool.ruff.lint]
extend-select = [
  "TID252", # flake8-tidy-imports banned API
]

[tool.ruff.lint.flake8-tidy-imports.banned-api]
"unittest.mock" = { msg = "Do not use mocks; prefer fixtures/fakes per .dev-guidelines/TESTING.md." }
"pytest_mock" = { msg = "Do not use pytest-mock; prefer fixtures/fakes per .dev-guidelines/TESTING.md." }
"mock" = { msg = "Do not use mock; prefer fixtures/fakes per .dev-guidelines/TESTING.md." }
"pytest.MonkeyPatch" = { msg = "Do not use monkeypatch; inject dependencies via fixtures and DI hooks." }

# When invoked without explicit targets, analyze only the project code.
[tool.mypy]
# When invoked without explicit targets, analyze only the project code.
files = ["src/ml_playground"]
# Also exclude common ignored/artifact directories if mypy is invoked without args.
# Additionally exclude analysis (LIT integration) to avoid pulling heavy third-party types
# that slow down type checking and are not part of core runtime.
exclude = '(^|.*/)(out/|data/|datasets/|checkpoints/|runs/|wandb/|lightning_logs/|artifacts/|mlruns/|htmlcov/|src/ml_playground/experiments/|src/ml_playground/analysis/|\\.idea/|\\.vscode/|\\.venv/|env/|\\.cache/|\\.git/)'

explicit_package_bases = true
mypy_path = ["src"]
namespace_packages = true

# Speed up type checking by not following imports into third-party libraries
follow_imports = "skip"
# Avoid spending time resolving missing type stubs for external deps (torch, transformers, etc.)
ignore_missing_imports = true
cache_dir = ".cache/mypy"


[tool.pytest.ini_options]
# Updated pytest settings for ml_playground
addopts = "-W error --strict-markers --strict-config -v -W \"ignore:Skipping collection of '.hypothesis' directory.*:UserWarning\""
pythonpath = ["src", "."]
testpaths = [
    "tests",
]
cache_dir = ".cache/pytest"
norecursedirs = [
    ".git",
    ".idea",
    ".vscode",
    ".venv",
    "env",
    "out",
    "data",
    "datasets",
    "checkpoints",
    "runs",
    "wandb",
    "lightning_logs",
    "artifacts",
    "mlruns",
    ".cache",
    ".hypothesis",
    "htmlcov",
]
filterwarnings = [
    # Hypothesis plugin warns when skipping '.hypothesis' if norecursedirs overrides defaults.
    # We centralize Hypothesis database under .cache/hypothesis; ignore this warning under -W error.
    "ignore:Skipping collection of '.hypothesis' directory.*:UserWarning",
]
markers = [
    "slow: marks tests as slow (deselected by default)",
    "integration: marks tests as integration tests",
    "acceptance: marks tests as acceptance (deselect with '-m \"not acceptance\"')",
    "e2e: marks tests as end-to-end tests",
]
bdd_features_base_dir = "tests/acceptance/features/"

[tool.ruff.lint.isort]
known-first-party = ["ml_playground", "tests", "tools"]
classes = []

[tool.coverage.run]
branch = true
parallel = true
data_file = ".cache/coverage/coverage.sqlite"
source = [
    "ml_playground",
]
omit = [
    "tests/*",
    "*/conftest.py",
    "**/datasets/*",
    "**/runs/*",
    "**/wandb/*",
    "**/lightning_logs/*",
    "**/artifacts/*",
    "**/mlruns/*",
    "**/.hf_cache/*",
    "**/.cache/*",
    "**/tools/*",
    "**/_remote_module_non_scriptable.py",
    # Temporarily exclude analysis (LIT integration) due to dependency issues
    "src/ml_playground/analysis/*",
]

[tool.coverage.report]
# Require 87% coverage to match combined unit+property gate while keeping reports strict
exclude_lines = [
    # Only allow exclusion for truly impossible-to-test code
    "if 0:",
    "if __name__ == .__main__.:",
]
show_missing = true
omit = [
    # Temporarily exclude analysis (LIT integration) due to dependency issues
    "src/ml_playground/analysis/*",
]
skip_covered = false
# Align with CI gate threshold for unit+property suites
fail_under = 87.0
precision = 2

[tool.coverage.html]
directory = ".cache/coverage/htmlcov"

[cosmic-ray]
module-path = "src/ml_playground"
timeout = 1.0
excluded-modules = [
  "ml_playground/core/tokenizer_protocol.py",
  "ml_playground/training/optim/lr_scheduler.py",
]
test-command = "pytest -q -n auto tests/unit"
no-copy-source-files = false

[cosmic-ray.session]
file = ".cache/cosmic-ray/session.sqlite"

[cosmic-ray.distributor]
name = "local"


